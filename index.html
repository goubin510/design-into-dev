<!DOCTYPE html>
<html>
<head>
	<title>FinanceDash</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<!-- Popper JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

	<style type="text/css">
		.row {
			padding: 10px;
		}
		.col, .col-2, .col-1 {
			min-width: 120px;
		}
		.form-control {
			margin-bottom: 10px;
		}

		/* OVERLAY */

		/* The Overlay (background) */
		.overlay {
		  /* Height & width depends on how you want to reveal the overlay (see JS below) */   
		  height: 100%;
		  width: 0;
		  position: fixed; /* Stay in place */
		  z-index: 1; /* Sit on top */
		  left: 0;
		  top: 0;
		  background-color: rgb(0,0,0); /* Black fallback color */
		  background-color: rgba(0,0,0, 0.9); /* Black w/opacity */
		  overflow-x: hidden; /* Disable horizontal scroll */
		  transition: 0.5s; /* 0.5 second transition effect to slide in or slide down the overlay (height or width, depending on reveal) */
		}

		/* Position the content inside the overlay */
		.overlay-content {
		  position: relative;
		  top: 25%; /* 25% from the top */
		  width: 100%; /* 100% width */
		  text-align: center; /* Centered text/links */
		  margin-top: 30px; /* 30px top margin to avoid conflict with the close button on smaller screens */
		}

		/* The navigation links inside the overlay */
		.overlay a {
		  padding: 8px;
		  text-decoration: none;
		  font-size: 36px;
		  color: #818181;
		  display: block; /* Display block instead of inline */
		  transition: 0.3s; /* Transition effects on hover (color) */
		}

		/* When you mouse over the navigation links, change their color */
		.overlay a:hover, .overlay a:focus {
		  color: #f1f1f1;
		}

		/* Position the close button (top right corner) */
		.overlay .closebtn {
		  position: absolute;
		  top: 20px;
		  right: 45px;
		  font-size: 60px;
		}

		/* When the height of the screen is less than 450 pixels, change the font-size of the links and position the close button again, so they don't overlap */
		@media screen and (max-height: 450px) {
		  .overlay a {font-size: 20px}
		  .overlay .closebtn {
		    font-size: 40px;
		    top: 15px;
		    right: 35px;
		  }
		}

		/* BTN */

		/* Blue */
		.info {
		  border-color: #2196F3;
		  color: dodgerblue
		}

		.info:hover {
		  background: #2196F3;
		  color: white;
		}
	</style>
</head>
<body>
<!-- ___________________________HEADER___________________________ -->
	<h1>Manage your spendings !</h1>

<!-- ___________________________OVERLAY___________________________ -->
	<div id="myNav" class="overlay">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>

		<div class="overlay-content row">
			<div class="col"></div>
			<div class="col jumbotron">
				<label for="amountDesc">Description:</label>
				<input type="text" class="form-control" id="amountDesc">

				<label for="amount">Amount:</label>
				<input type="text" class="form-control" id="amount">

				<label for="category">Category:</label>
				<select class="form-control" id="category" name="sellist1">
					<option>Loisirs</option>
					<option>Epargne</option>
					<option>Obligations</option>
					<option>Revenue</option>
					<option>Provisoire</option>
				</select>

				<label for="date">Date:</label>
				<input type="date" class="form-control" id="date">

				<button class="btn btn-primary" id="send">Send</button>
			</div>
			<div class="col"></div>
		</div>
	</div>
<!-- ___________________________PASSPHRASE___________________________ -->
	<div class="form-group row">
		<div class="col">
			<form>
				<label for="pwd">Passphrase:</label>
				<input type="password" name="password" class="form-control" id="pwd">
				<input type="submit" class="btn btn-info" id="getInfo">
			</form>
				<br>
				<button class="btn btn-success" id="getInfo">Retrieve Data</button>
				<button class="btn info" onclick="openNav()">Add Data</button>
		</div>
	</div>

<!-- ___________________________RESULT___________________________ -->
	<div class="row">
		<div class="col">
			<h1>Results :</h1>
		</div>	
	</div>

	<div class="row">
		<div class="col-2">
			<p>
				Loisirs :
			</p>
			<p>
				Epargne :
			</p>
			<p>
				Obligations :
			</p>

			<hr>

			<p>
				TT :
			</p>
			<p>
				Revenue :

			<hr>

			<p>
				Provisoire :
			</p>
		</div>
		<div class="col-1">
			<p>
				<strong id="desiresValue">-</strong>
			</p>
			<p>
				<strong id="savingsValue">-</strong>
			</p>
			<p>
				<strong id="needsValue">-</strong>
			</p>

			<hr>

			<p>
				<strong id="ttValue">-</strong>
			</p>
			<p>
				<strong id="revenueValue">-</strong>

			<hr>

			<p>
				<strong id="provisionValue">-</strong>
			</p>
		</div>
		<div class="col-1">
			<p>
				(<light id="desiresRatio">-</light>)
			</p>
			<p>
				(<light id="savingsRatio">-</light>)
			</p>
			<p>
				(<light id="needsRatio">-</light>)
			</p>

			<hr>

			<p>
				(<light id="ttRatio">-</light>)
			</p>
			<p>
				(<light id="revenueRatio">-</light>)
			</p>

			<hr>

			<p>
				(<light id="provisionRatio">-</light>)
			</p>
		</div>
	</div>

<!-- ___________________________ANALYSIS___________________________ -->
	<div class="row">

<!-- ___________________________A QUOTAS___________________________ -->
		<div class="col">
			<h2>Daily Quota</h2>
			<p>
				Desires : <strong id="desiresQuota"></strong> €
			</p>
			<p>
				Savings : <strong id="savingsQuota"></strong> €
			</p>
			<p>
				Needs : <strong id="needsQuota"></strong> €
			</p>
		</div>

<!-- ___________________________A OVERVIEW___________________________ -->
		<div class="col">
			<h2>Overview</h2>
			<p>
				Desires : <strong id="desiresSpent"></strong>
				(<light id="desiresSpentRatio"></light>)
			</p>
			<p>
				Savings : <strong id="savingsSpent"></strong>
				(<light id="savingsSpentRatio"></light>)
			</p>
			<p>
				Needs : <strong id="needsSpent"></strong>
				(<light id="needsSpentRatio"></light>)
			</p>
			<p>
				Revenue : <strong id="revenueSpent"></strong>
				(<light id="revenueSpentRatio"></light>)
			</p>
		</div>

<!-- ___________________________A FORECAST___________________________ -->
		<div class="col">
			<h2>Forecast</h2>
			<p>
				Desires : <strong id="desiresFutureQuota"></strong> €
				(<light id="desiresRest"></light> €)
			</p>
			<p>
				Savings : <strong id="savingsFutureQuota"></strong> €
				(<light id="savingsRest"></light> €)
			</p>
			<p>
				Needs : <strong id="needsFutureQuota"></strong> €
				(<light id="needsRest"></light> €)
			</p>
		</div>
	</div>
	<div class="row">

<!-- ___________________________ACTION___________________________ -->
		<div class="col">
			<button class="btn btn-warning" id="work">Run Analysis</button>
		</div>
	</div>


</body>
<script type="text/javascript">

	$("#getInfo").click(function(){
		var date = new Date();
		date.setDate(0);
		date.setHours(0,0,0);

		var json = {};
		json.identificationStr =  $("#pwd").val();
		json.date = {$gte: date};

		$.post("/", json, function(data){

			var results = Bilan(data)

			console.log(results)

			fillResults(results)
		});
	});

	$("#send").click(function(){
		var json = {};

		json.description = $("#amountDesc").val();
		json.amount = $("#amount").val();
		json.category = $("#category").val();
		json.identificationStr = $("#pwd").val();
		json.date = () => {if($("#date").val()) return $("#date").val(); else return Date.now()}

		$.post("/data", json,
		function(res){
			$("#amountDesc").val("");
			$("#amount").val(0);
		});
	});

	$("#work").click(function(){
		var date = new Date();
		date.setDate(date.getDate() - 1)
		date.setHours(23,59,59);

		var json = {};
		json.date = {$lte: date}
		json.identificationStr = $("#pwd").val();

		$.post("/", json,
		function(data){
			var results = Bilan(data);
			
			// console.log(results)

			var rest = results.total[3] - results.total[0] - results.total[1] - results.total[2];

			$("#desiresQuota").text(rest * 0.2 / (32 - new Date().getDate()))
			$("#savingsQuota").text(rest * 0.3 / (32 - new Date().getDate()))
			$("#needsQuota").text(rest * 0.5 / (32 - new Date().getDate()))
		});

		var lowerDate = new Date();
		lowerDate.setHours(0,0,0);
		var higherDate = new Date();
		higherDate.setHours(23,59,59);

		json = {};
		json.date = {$lte: higherDate, $gte: lowerDate}
		json.identificationStr = $("#pwd").val();

		$.post("/", json,
		function(data){
			var results = Bilan(data);
			
			// console.log(results)

			var rest = results.total[3] - results.total[0] - results.total[1] - results.total[2];

			$("#desiresSpent").text(results.total[0] + " €")
			$("#savingsSpent").text(results.total[1] + " €")
			$("#needsSpent").text(results.total[2] + " €")
			$("#revenueSpent").text(results.total[3] + " €")
		});
	});

	function Bilan (data) {
		var total = [], logs = [], ratio = [], ref = [];

		logs [0] = [];
		logs [1] = [];
		logs [2] = [];
		logs [3] = [];
		logs [4] = [];
		total [0] = 0;
		total [1] = 0;
		total [2] = 0;
		total [3] = 0;
		total [4] = 0;

		for (var i = 0; i < data.length; i++) {

			var phrase = data[i].description + " : " + data[i].amount + "(" + data[i].date + ")";

			switch (data[i].category) {
				case 'Loisirs':
					total[0] += data[i].amount;
					logs[0].push(phrase)
				break;
				case 'Epargne':
					total[1] += data[i].amount;
					logs[1].push(phrase)
				break;
				case 'Obligations':
					total[2] += data[i].amount;
					logs[2].push(phrase)
				break;
				case 'Revenue':
					total[3] += data[i].amount;
					logs[3].push(phrase)
				break;
				case 'Provisoire':
					total[4] += data[i].amount;
					logs[4].push(phrase)
			}
		}

		var spent = 0 + total[0] + total[1] + total[2];
		var ratioDate = new Date();

		ratio[0] = 100 * total[0] / spent;
		ratio[1] = 100 * total[1] / spent;
		ratio[2] = 100 * total[2] / spent;
		ratio[3] = 100 * ratioDate.getDate() / 32;		
		ratio[4] = 100 * total[4] / total[3];

		return {"total": total, "logs": logs, "ratio": ratio};
	}

	function fillResults (data) {
		$("#desiresValue").text(" " + data.total[0] + " € ")
		$("#savingsValue").text(" " + data.total[1] + " € ")
		$("#needsValue").text(" " + data.total[2] + " € ")
		$("#revenueValue").text(" " + data.total[3] + " € ")
		$("#provisionValue").text(" " + data.total[4] + " € ")
		$("#desiresRatio").text(" " + data.ratio[0].toFixed(2) + " % ")
		$("#savingsRatio").text(" " + data.ratio[1].toFixed(2) + " % ")
		$("#needsRatio").text(" " + data.ratio[2].toFixed(2) + " % ")
		$("#revenueRatio").text(" " + data.ratio[3].toFixed(2) + " % ")		
		$("#provisionRatio").text(" " + data.ratio[4].toFixed(2) + " % " )

		var spent = 0 + data.total[0] + data.total[1] + data.total[2];
		$("#ttValue").text(" " + spent + " €");
		$("#ttRatio").text(" " + (100*spent/data.total[3]).toFixed(2) + " % ");
		var rest = data.total[3] - spent;

		if(data.ratio[0] > 30)
			$("#desiresRatio").css({"color": 'red'});
		else $("#desiresRatio").css({"color": 'LimeGreen'});

		if(data.ratio[1] < 20)
			$("#savingsRatio").css({"color": 'red'});
		else $("#savingsRatio").css({"color": 'LimeGreen'});

		if(data.ratio[2] > 50)
			$("#needsRatio").css({"color": 'red'});
		else $("#needsRatio").css({"color": 'LimeGreen'});
	}

	function openNav() {
	  document.getElementById("myNav").style.width = "100%";
	}

	function closeNav() {
	  document.getElementById("myNav").style.width = "0%";
	}
</script>
</html>